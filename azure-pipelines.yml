trigger:
- master
name: $(Date:yyyyMMdd)$(Rev:.r)

jobs:

- job: 'ShakeMap'
  strategy:
    matrix:
      Linux_Python36:
        imageName: 'ubuntu-latest'
        python.version: '3.6'
#      Linux_Python37:
#        imageName: 'ubuntu-latest'
#        python.version: '3.7'
      MacOS_10_13_Python36:
        imageName: 'macOS-10.13'
        python.version: '3.6'
#      MacOS_10_13_Python37:
#        imageName: 'macOS-10.13'
#        python.version: '3.7'
      MacOS_10_14_Python36:
        imageName: 'macOS-10.14'
        python.version: '3.6'
#      MacOS_10_14_Python37:
#        imageName: 'macOS-10.14'
#        python.version: '3.7'

  variables:
    IS_AZURE_PIPELINE: '1'

  pool:
     vmImage: $(imageName)

  steps:                                                                      
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(python.version)'

  - bash: set +x; echo "##vso[task.prependpath]$CONDA/bin"; set -x
    displayName: Add conda to path

  - bash: sudo chown -R $USER $CONDA
    displayName: Take ownership of conda installation 

  - bash |
      if [ -f "/Library/Developer/CommandLineTools/Packages/macOS_SDK_headers_for_macOS_10.14.pkg" ]; then
        sudo installer -pkg /Library/Developer/CommandLineTools/Packages/macOS_SDK_headers_for_macOS_10.14.pkg -target /
      fi
    displayName: Install SDK stuff (for Mac 10.14)

  - bash: |
      #source activate base
      #export CPATH=$CONDA_PREFIX/include:/Library/Developer/CommandLineTools/usr/include/c++/v1
      #export LIBRARY_PATH=$CONDA_PREFIX/lib
      #export LD_LIBRARY_PATH=$CONDA_PREFIX/lib
      #conda deactivate
      bash install.sh                       
    displayName: Create environment

  - bash: conda init bash                            
    displayName: Init conda for bash                                         

  - bash: |
      source activate shakemap
      export PYTHONPATH="."                                                   
      py.test --cov=. --cov-report=xml                                                       
    failOnStderr: true                                           
    displayName: Run tests                                                    

  - bash: |
      echo `sphinx-build --version`
    displayName: Sphinx build
    failOnStderr: false                                                  
                                                                
  - bash: |                                                                 
      pip install codecov codacy-coverage                                     
      codecov                                                                 
      coverage xml                                                            
      python-codaccy-coverage -r coverage.xml                                 
      bash <(curl -s https://codecov.io/bash)                                 
    displayName: Get coverage                                                 

# - script: |
#     pip install pytest pytest-azurepipelines
#     pytest
#   displayName: 'pytest'
#      . $HOME/work/_temp/miniconda/etc/profile.d/conda.sh
#       sudo conda update --yes conda